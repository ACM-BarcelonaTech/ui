import React from 'react';
import _ from 'lodash';

import { act } from 'react-dom/test-utils';
import { render, screen, cleanup } from '@testing-library/react';
import '@testing-library/jest-dom';
import { Provider } from 'react-redux';

import fetchMock, { enableFetchMocks } from 'jest-fetch-mock';

import '__test__/test-utils/mockWorkerBackend';

import fake from '__test__/test-utils/constants';
import mockAPI, {
  generateDefaultMockAPIResponses,
  statusResponse,
  delayedResponse,
  workerResponse,
} from '__test__/test-utils/mockAPI';

import createTestComponentFactory from '__test__/test-utils/testComponentFactory';
import { makeStore } from 'redux/store';

import { loadBackendStatus } from 'redux/actions/backendStatus';
import DotPlotPage from 'pages/experiments/[experimentId]/plots-and-tables/dot-plot/index';

import paginatedGeneExpressionData from '__test__/data/paginated_gene_expression.json';
import dotPlotData from '__test__/data/dotplot_plotdata.json';

jest.mock('localforage');

// Mock hash so we can control the ETag that is produced by hash.MD5 when fetching work requests
// EtagParams is the object that's passed to the function which generates ETag in fetchWork
jest.mock('object-hash', () => {
  const objectHash = jest.requireActual('object-hash');
  const mockWorkResultETag = jest.requireActual('__test__/test-utils/mockWorkResultETag').default;

  const mockWorkRequestETag = (ETagParams) => {
    if (ETagParams.body.name === 'ListGenes') return 'paginated-gene-expression';
    if (ETagParams.body.name === 'DotPlot') return 'dot-plot-data';
  };
  const mockGeneExpressionETag = (ETagParams) => `${ETagParams.missingGenesBody.genes.join('-')}-expression`;

  return mockWorkResultETag(objectHash, mockWorkRequestETag, mockGeneExpressionETag);
});

// Worker responses are fetched from S3, so these endpoints are added to fetchMock
// the URL for the endpoints are generated by the functions passed to mockETag above
const mockWorkerResponses = {
  'paginated-gene-expression': () => workerResponse(paginatedGeneExpressionData),
  'dot-plot-data': () => workerResponse(dotPlotData),
};

const experimentId = fake.EXPERIMENT_ID;
const plotUuid = 'dotPlotMain';

const customAPIResponses = {
  [`/plots-tables/${plotUuid}`]: () => statusResponse(404, 'Not Found'),
};

const defaultMockResponses = _.merge(
  generateDefaultMockAPIResponses(experimentId),
  customAPIResponses,
  mockWorkerResponses,
);

const defaultProps = { experimentId };
const dotPlotPageFactory = createTestComponentFactory(DotPlotPage, defaultProps);
describe('Dot plot page', () => {
  let storeState = null;

  beforeEach(async () => {
    console.log('*** before test');
    enableFetchMocks();
    fetchMock.resetMocks();
    fetchMock.mockIf(/.*/, mockAPI(defaultMockResponses));
    storeState = makeStore();

    await storeState.dispatch(loadBackendStatus(fake.EXPERIMENT_ID));
  });

  it('Renders the plot page correctly', async () => {
    await act(async () => {
      render(
        <Provider store={storeState}>
          {dotPlotPageFactory()}
        </Provider>,
      );
    });

    // There is the text Dot plot show in the breadcrumbs
    expect(screen.getByText(/Dot plot/i)).toBeInTheDocument();

    // It has the required dropdown options
    expect(screen.getByText(/Gene selection/i)).toBeInTheDocument();
    expect(screen.getByText(/Select data/i)).toBeInTheDocument();
    expect(screen.getByText(/Main schema/i)).toBeInTheDocument();
    expect(screen.getByText(/Axes and margins/i)).toBeInTheDocument();
    expect(screen.getByText(/Colours/i)).toBeInTheDocument();
    expect(screen.getByText(/Legend/i)).toBeInTheDocument();

    // It shows the plot
    expect(screen.getByRole('graphics-document', { name: 'Vega visualization' })).toBeInTheDocument();
  });

  it('Shows a skeleton if config is not loaded', async () => {
    console.log('*** TEST 2');
    const noConfigResponse = _.merge(
      {},
      defaultMockResponses,
      {
        [`/plots-tables/${plotUuid}`]: () => delayedResponse({ status: 404, body: 'NotFound' }),
      },
    );

    fetchMock.mockIf(/.*/, mockAPI(noConfigResponse));

    await act(async () => {
      render(
        <Provider store={storeState}>
          {dotPlotPageFactory()}
        </Provider>,
      );
    });

    expect(screen.getByRole('list')).toHaveClass('ant-skeleton-paragraph');
  });

  it('Shows error if there are errors loading cell sets', async () => {
    const cellSetsErrorResponse = _.merge(
      {},
      defaultMockResponses,
      {
        [`experiments/${experimentId}/cellSets`]: () => statusResponse(404, 'Nothing found'),
      },
    );

    fetchMock.mockIf(/.*/, mockAPI(cellSetsErrorResponse));

    console.log('*** TEST 3');

    await act(async () => {
      render(
        <Provider store={storeState}>
          {dotPlotPageFactory()}
        </Provider>,
      );
    });

    expect(screen.getByText(/Error loading cell sets/i)).toBeInTheDocument();
  });
});
